#!/bin/bash

set -e

# Determine the main branch
MAIN_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
if [ -z "$MAIN_BRANCH" ]; then
  if git show-ref --verify --quiet refs/heads/main; then
    MAIN_BRANCH="main"
  elif git show-ref --verify --quiet refs/heads/master; then
    MAIN_BRANCH="master"
  else
    echo "Error: Could not determine main branch"
    exit 1
  fi
fi

echo "Finding merged branches with worktrees..."
echo ""

# Get list of all worktrees (excluding main)
WORKTREES=()

# Parse porcelain format
worktree_path=""
branch=""

while IFS= read -r line; do
  if [[ "$line" =~ ^worktree ]]; then
    worktree_path="${line#worktree }"
  elif [[ "$line" =~ ^branch ]]; then
    # Extract branch name from refs/heads/branch-name
    branch="${line#branch refs/heads/}"

    # Skip if it's the main branch
    [ "$branch" = "$MAIN_BRANCH" ] && continue

    # Check if branch has any commits ahead of main
    ahead=$(git rev-list --count "$MAIN_BRANCH".."$branch" 2>/dev/null || echo "0")

    # Skip branches with no commits (no work started)
    [ "$ahead" -eq 0 ] && continue

    # Check if branch is merged (using cherry detection)
    unique=$(git log --cherry-mark --right-only --no-merges --oneline "$MAIN_BRANCH"..."$branch" 2>/dev/null | grep -v "^=" | wc -l | xargs)

    if [ "$unique" -eq 0 ]; then
      WORKTREES+=("$worktree_path|$branch")
    fi
  fi
done < <(git worktree list --porcelain)

if [ ${#WORKTREES[@]} -eq 0 ]; then
  echo "No merged branches with worktrees found!"
  exit 0
fi

echo "Found ${#WORKTREES[@]} merged worktree(s):"
echo ""

# Display what will be deleted
for item in "${WORKTREES[@]}"; do
  worktree_path="${item%|*}"
  branch="${item#*|}"

  echo "Branch: $branch"
  echo "  Worktree: $worktree_path"

  # Find Claude projects
  CLAUDE_PROJECT_BASE="$(echo "$worktree_path" | tr '/' '-')"
  claude_projects=$(find "$HOME/.claude/projects" -maxdepth 1 -type d -name "${CLAUDE_PROJECT_BASE}*" 2>/dev/null | wc -l)
  if [ "$claude_projects" -gt 0 ]; then
    echo "  Claude projects: $claude_projects"
  fi
  echo ""
done

# Confirm deletion
read -p "Delete all ${#WORKTREES[@]} worktree(s), branches, and Claude projects? (y/N) " -n 1 -r
echo
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

# Process each worktree
for item in "${WORKTREES[@]}"; do
  worktree_path="${item%|*}"
  branch="${item#*|}"

  echo "Processing: $branch"

  # Remove worktree
  git worktree remove "$worktree_path" --force 2>/dev/null || true
  echo "  ✓ Removed worktree"

  # Delete branch
  git branch -D "$branch" 2>/dev/null || true
  echo "  ✓ Deleted branch"

  # Delete Claude projects
  CLAUDE_PROJECT_BASE="$(echo "$worktree_path" | tr '/' '-')"
  claude_count=0
  while IFS= read -r proj; do
    rm -rf "$proj"
    ((claude_count++))
  done < <(find "$HOME/.claude/projects" -maxdepth 1 -type d -name "${CLAUDE_PROJECT_BASE}*" 2>/dev/null)

  if [ "$claude_count" -gt 0 ]; then
    echo "  ✓ Deleted $claude_count Claude project(s)"
  fi

  echo ""
done

echo "✓ Cleanup complete! Removed ${#WORKTREES[@]} merged worktree(s)."
